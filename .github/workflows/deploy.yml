name: Deploy to Cloudflare Pages

on:
   push:
      branches: [main]

jobs:
   deploy:
      runs-on: ubuntu-latest
      permissions:
         contents: read
         deployments: write
      name: Deploy to Cloudflare Pages
      steps:
         - name: Checkout
           uses: actions/checkout@v4

         - name: Setup Node
           uses: actions/setup-node@v4
           with:
              node-version: 20

         - name: Install dependencies
           run: npm ci

         - name: Ensure Cloudflare Project Exists
           run: npx wrangler pages project create juansadigital-astro --production-branch main || true
           env:
              CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
              CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

         - name: Assign Custom Domain
           run: npx wrangler pages domain add juansadigital-astro juansa.connexis.co || true
           env:
              CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
              CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

         - name: Build
           run: npm run build

         - name: Publish to Cloudflare Pages
           uses: cloudflare/pages-action@v1
           with:
              apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
              accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
              projectName: juansadigital-astro
              directory: dist
              gitHubToken: ${{ secrets.GITHUB_TOKEN }}
